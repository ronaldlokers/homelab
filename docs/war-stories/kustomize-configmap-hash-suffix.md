# Kustomize ConfigMap Hash Suffix Breaking Alloy Configuration

**Date**: December 2025
**Environment**: Staging cluster - Grafana Alloy deployment
**Impact**: Alloy pods failing to start, unable to load configuration file

## The Problem

After deploying Grafana Alloy using a ConfigMap generated by Kustomize, the pods were crashing on startup with configuration file not found errors.

**Error in alloy pod logs**:
```
Error: failed to load config file: open /etc/alloy/config.alloy: no such file or directory
```

**Symptoms**:
- Alloy pods in `CrashLoopBackOff` state
- ConfigMap created successfully
- Volume mount looks correct in pod spec
- Configuration file exists in ConfigMap but not in pod

## The Investigation

### Checking ConfigMap

```bash
kubectl get configmap -n monitoring | grep alloy
# NAME                           DATA   AGE
# alloy-config-cgbd86b72m        1      5m   ← Hash suffix added!
```

**Kustomize added a hash suffix!** This is a feature to trigger pod restarts when ConfigMap content changes.

### Checking HelmRelease Configuration

```yaml
# monitoring/controllers/staging/alloy/release.yaml
alloy:
  configMap:
    create: false              # Don't create, use external
    name: alloy-config         # ❌ Expects "alloy-config"
    key: config.alloy
```

**The problem**:
- HelmRelease expects ConfigMap named `alloy-config`
- Kustomize creates ConfigMap named `alloy-config-cgbd86b72m`
- Names don't match → Volume mount fails → File not found

### Checking Kustomization

```yaml
# monitoring/controllers/staging/alloy/kustomization.yaml
configMapGenerator:
  - name: alloy-config
    files:
      - config.alloy
    # No options specified - defaults to adding hash suffix
```

### Understanding Kustomize ConfigMap Generation

Kustomize has two modes for ConfigMaps:

1. **With hash suffix** (default):
   - Name: `alloy-config-cgbd86b72m`
   - Changes hash when content changes
   - Triggers automatic pod restarts
   - Requires references to use Kustomize substitution

2. **Without hash suffix** (opt-in):
   - Name: `alloy-config` (as specified)
   - Keeps stable name
   - Requires manual pod restarts on changes
   - Works with hardcoded references

## The Root Cause

**Kustomize's default ConfigMap hash suffix conflicts with Helm's static ConfigMap references.**

Kustomize workflow:
```
1. Generate ConfigMap with hash: alloy-config-cgbd86b72m
2. Apply to cluster
3. Helm chart references: alloy-config (hardcoded in values)
4. Mount fails: ConfigMap "alloy-config" not found
```

The hash suffix is useful for:
- Detecting ConfigMap changes
- Triggering rolling updates
- Immutable ConfigMap pattern

**But**: The HelmRelease values have a hardcoded ConfigMap name that doesn't know about the hash.

## The Solution

### Disable Hash Suffix in Kustomization

Modified `monitoring/controllers/staging/alloy/kustomization.yaml`:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: monitoring
resources:
  - ../../base/alloy/
  - release.yaml

configMapGenerator:
  - name: alloy-config
    files:
      - config.alloy
    options:
      disableNameSuffixHash: true  # ✓ Keep stable name
```

### Apply and Verify

```bash
# Reconcile Flux Kustomization
flux reconcile kustomization monitoring-controllers --context=staging

# Check ConfigMap name
kubectl get configmap -n monitoring | grep alloy
# NAME             DATA   AGE
# alloy-config     1      1m   ✓ No hash suffix!

# Check Alloy pods
kubectl get pods -n monitoring -l app.kubernetes.io/name=alloy
# NAME                     READY   STATUS    RESTARTS
# alloy-abcd-12345         1/1     Running   0         ✓ Working!

# Verify config loaded
kubectl logs -n monitoring -l app.kubernetes.io/name=alloy --tail=20
# level=info msg="config loaded successfully"
```

## When to Use Hash Suffix vs Stable Names

### Use Hash Suffix (Default)

**When**:
- ConfigMap referenced by Deployment/StatefulSet directly
- Want automatic restarts on config changes
- Using Kustomize variable substitution

**Example**:
```yaml
# kustomization.yaml
configMapGenerator:
  - name: app-config
    files:
      - config.yaml
    # Hash suffix enabled (default)

# deployment.yaml
spec:
  template:
    spec:
      containers:
        - name: app
          envFrom:
            - configMapRef:
                name: app-config  # Kustomize replaces with app-config-<hash>
```

Kustomize automatically updates all references.

### Use Stable Names (disableNameSuffixHash: true)

**When**:
- ConfigMap referenced by Helm chart values
- External system expects specific name
- Manual control over pod restarts preferred

**Example**:
```yaml
# kustomization.yaml
configMapGenerator:
  - name: alloy-config
    files:
      - config.alloy
    options:
      disableNameSuffixHash: true  # Stable name

# helmrelease.yaml (Helm values)
alloy:
  configMap:
    name: alloy-config  # ✓ Matches exactly
```

Helm doesn't know about Kustomize hashes, so we need a stable name.

## Alternative Solutions

### Option 1: Let Helm Manage ConfigMap

**Don't use Kustomize configMapGenerator at all**:

```yaml
# helmrelease.yaml
alloy:
  configMap:
    create: true  # Let Helm create it
    content: |
      # Alloy configuration inline
      logging {
        level = "info"
      }
```

**Pros**: Single source of truth (Helm)
**Cons**: Large config in values YAML, less readable

### Option 2: Use Kustomize Variable Substitution

**Let Kustomize rewrite the HelmRelease**:

```yaml
# kustomization.yaml
configMapGenerator:
  - name: alloy-config
    files:
      - config.alloy
    # Hash enabled (default)

configurations:
  - kustomizeconfig.yaml  # Teach Kustomize about HelmRelease format
```

**Pros**: Automatic hash handling
**Cons**: Complex, requires custom Kustomize config

### Option 3: Disable Hash (Our Choice)

**Use stable names**:

```yaml
configMapGenerator:
  - name: alloy-config
    files:
      - config.alloy
    options:
      disableNameSuffixHash: true
```

**Pros**: Simple, works with Helm
**Cons**: Must manually restart pods on config changes

## Triggering Restarts After Config Changes

With `disableNameSuffixHash: true`, config changes don't auto-restart pods.

### Manual Restart Options

**Option 1: Rollout restart**
```bash
kubectl rollout restart daemonset/alloy -n monitoring
```

**Option 2: Delete pods** (DaemonSet recreates)
```bash
kubectl delete pods -n monitoring -l app.kubernetes.io/name=alloy
```

**Option 3: Flux reconcile** (if HelmRelease recreates pods)
```bash
flux reconcile helmrelease alloy -n monitoring
```

### Automatic Restart with Flux

Flux HelmRelease can be configured to recreate pods:

```yaml
spec:
  upgrade:
    force: true  # Force recreation on upgrade
```

**Note**: This recreates ALL resources, not just pods.

## Lessons Learned

1. **Kustomize and Helm have different patterns**: ConfigMap generation needs coordination
   - Kustomize: Dynamic names with hashes
   - Helm: Static names in values

2. **Hash suffixes are opt-out, not opt-in**: Default behavior adds hashes
   - Good for pure Kustomize deployments
   - Problematic when mixing with Helm

3. **Read error messages carefully**: "config.alloy not found" could mean:
   - File missing from ConfigMap (wrong)
   - ConfigMap name mismatch (correct)

4. **Check actual resource names in cluster**: Don't assume they match manifests
   ```bash
   kubectl get configmap -n monitoring
   # Shows actual names with hashes
   ```

## Prevention Checklist

When using Kustomize configMapGenerator with Helm:

- [ ] Decide: Hash suffix or stable name?
- [ ] If using with Helm: Add `disableNameSuffixHash: true`
- [ ] If using hash: Configure Kustomize to rewrite references
- [ ] Test deployment end-to-end
- [ ] Verify ConfigMap name matches expectations
- [ ] Document restart procedure for config changes
- [ ] Set up monitoring for pod restarts

## Common Variations of This Problem

### Secrets with Hash Suffix

Same issue with `secretGenerator`:

```yaml
secretGenerator:
  - name: db-credentials
    files:
      - password.txt
    options:
      disableNameSuffixHash: true  # If referenced by Helm
```

### Multiple ConfigMaps

Some need hash, some need stable names:

```yaml
configMapGenerator:
  - name: app-config
    files:
      - app.yaml
    # Hash enabled (pure Kustomize)

  - name: helm-config
    files:
      - config.yaml
    options:
      disableNameSuffixHash: true  # Stable (used by Helm)
```

## Timeline

- **Alloy deployed**: Initial deployment with configMapGenerator
- **Issue discovered**: Pods in CrashLoopBackOff
- **Investigation**: Checked logs (file not found), ConfigMaps (hash suffix)
- **Root cause identified**: Name mismatch between Kustomize and Helm
- **Solution**: Added `disableNameSuffixHash: true`
- **Verification**: Pods started successfully, config loaded
- **Time to fix**: ~10 minutes (after finding the hash suffix)

## References

- [Kustomize ConfigMap Generator](https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/configmapgenerator/)
- [Kustomize Name Suffix Hash](https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/generatoroptions/)
- [Flux HelmRelease with External ConfigMaps](https://fluxcd.io/flux/components/helm/helmreleases/)
